---

title: Dynamic `WHERE` Clause 


keywords: fastai
sidebar: home_sidebar



nb_path: "Demo.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: Demo.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">jinjasql</span> <span class="kn">import</span> <span class="n">JinjaSql</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">JinjaSql</span><span class="p">(</span><span class="n">param_style</span><span class="o">=</span><span class="s1">&#39;pyformat&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT project, timesheet, hours</span>
<span class="s2">    FROM timesheet</span>
<span class="s2">    WHERE user_id = {{ user_id }}</span>
<span class="s2">    {</span><span class="si">% i</span><span class="s2">f project_id %}</span>
<span class="s2">    AND project_id = {{ project_id }}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">template</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;\n    SELECT project, timesheet, hours\n    FROM timesheet\n    WHERE user_id = {{ user_id }}\n    {% if project_id %}\n    AND project_id = {{ project_id }}\n    {% endif %}\n&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;project_id&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="sa">u</span><span class="s2">&quot;sripathi&quot;</span>
<span class="p">}</span>

<span class="n">query</span><span class="p">,</span> <span class="n">bind_params</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">prepare_query</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
    SELECT project, timesheet, hours
    FROM timesheet
    WHERE user_id = %(user_id_1)s
    
    AND project_id = %(project_id_2)s
    
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1">#     &quot;project_id&quot;: 123,</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="sa">u</span><span class="s2">&quot;sripathi&quot;</span>
<span class="p">}</span>

<span class="n">query</span><span class="p">,</span> <span class="n">bind_params</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">prepare_query</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
    SELECT project, timesheet, hours
    FROM timesheet
    WHERE user_id = %(user_id_1)s
    
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Notice that the <code>AND</code> clause is automatically removed using the <code>Jinja</code> if/else condition.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">query</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;\n    SELECT project, timesheet, hours\n    FROM timesheet\n    WHERE user_id = %(user_id_1)s\n    &#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">query</span> <span class="o">%</span><span class="k">bind_params</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;\n    SELECT project, timesheet, hours\n    FROM timesheet\n    WHERE user_id = sripathi\n    &#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bind_params</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;user_id_1&#39;: &#39;sripathi&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">string_types</span>

<span class="k">def</span> <span class="nf">quote_sql_string</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    If `value` is a string type, escapes single quotes in the string</span>
<span class="sd">    and returns the string enclosed in single quotes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="k">def</span> <span class="nf">get_sql_from_template</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">bind_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bind_params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bind_params</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">quote_sql_string</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query</span> <span class="o">%</span> <span class="n">params</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select</span>
<span class="s2">    user_id</span>
<span class="s2">    , count(*) as num_transactions</span>
<span class="s2">    , sum(amount) as total_amount</span>
<span class="s2">from</span>
<span class="s2">    transactions</span>
<span class="s2">where</span>
<span class="s2">    user_id = </span><span class="si">%(user_id)s</span><span class="s2"></span>
<span class="s2">    and transaction_date = </span><span class="si">%(transaction_date)s</span><span class="s2"></span>
<span class="s2">group by</span>
<span class="s2">    user_id</span>
<span class="s2">    &quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_sql_from_template</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bind_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;transaction_date&#39;</span><span class="p">:</span><span class="s1">&#39;123&#39;</span><span class="p">}))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
select
    user_id
    , count(*) as num_transactions
    , sum(amount) as total_amount
from
    transactions
where
    user_id = &#39;1&#39;
    and transaction_date = &#39;123&#39;
group by
    user_id
    
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Reference">Reference<a class="anchor-link" href="#Reference"> </a></h1><ul>
<li><a href="https://towardsdatascience.com/a-simple-approach-to-templated-sql-queries-in-python-adc4f0dc511">https://towardsdatascience.com/a-simple-approach-to-templated-sql-queries-in-python-adc4f0dc511</a></li>
</ul>

</div>
</div>
</div>
</div>
 

